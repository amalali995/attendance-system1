<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="scan-container">
        <div class="scan-card">
            <div class="scan-logo">
                <i class="fas fa-user-graduate"></i>
            </div>
            <h1 class="scan-title">ğŸ˜Š WELCOM </h1>
            <p class="scan-message"> Please Enter Your ID Number </p>
            
            <div class="scan-form">
                <label for="studentId"> ID :</label>
                <input type="text" id="studentId" placeholder="Enter your ID number">
            </div>
            
            <button class="scan-btn" onclick="recordAttendance()">
                <i class="fas fa-check"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
            </button>
            
            <div id="attendanceResult" class="scan-result"></div>
            
            <div class="scan-info">
                <i class="fas fa-info-circle"></i>
                <p>ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</p>
            </div>
        </div>
    </div>

    <script>
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø¹Ù†ÙˆØ§Ù† URL
        function getScannedCode() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('code');
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ÙƒÙˆØ¯
        function isValidCode(code) {
            if (!code) return false;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸ ÙÙŠ localStorage
            const storedCode = localStorage.getItem('currentQRCode');
            if (storedCode) {
                const codeData = JSON.parse(storedCode);
                if (code === codeData.code) {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                    return Date.now() < codeData.expiry;
                }
            }
            
            return false;
        }
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
        function recordAttendance() {
            const studentId = document.getElementById('studentId').value;
            const scannedCode = getScannedCode();
            const resultElement = document.getElementById('attendanceResult');
            
            if (!studentId) {
                resultElement.innerHTML = '<span class="scan-error">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</span>';
                return;
            }
            
            if (!scannedCode) {
                resultElement.innerHTML = '<span class="scan-error">ÙƒÙˆØ¯ QR ØºÙŠØ± ØµØ§Ù„Ø­</span>';
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ÙƒÙˆØ¯
            if (!isValidCode(scannedCode)) {
                resultElement.innerHTML = '<span class="scan-error">ÙƒÙˆØ¯ QR ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</span>';
                return;
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
            const students = JSON.parse(localStorage.getItem('students')) || [];
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨
            const student = students.find(s => s.id === studentId);
            if (!student) {
                resultElement.innerHTML = '<span class="scan-error">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>';
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±Ù‡ Ø§Ù„ÙŠÙˆÙ…
            const now = new Date();
            const today = now.toLocaleDateString('ar-EG');
            let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
            
            const alreadyRegistered = attendanceRecords.some(record => 
                record.studentId === studentId && record.date === today
            );
            
            if (alreadyRegistered) {
                resultElement.innerHTML = '<span class="scan-error">Ù„Ù‚Ø¯ Ø³Ø¬Ù„Øª Ø­Ø¶ÙˆØ±Ùƒ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø§Ù„ÙŠÙˆÙ…</span>';
                return;
            }
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
            const attendanceRecord = {
                studentId: student.id,
                studentName: student.name,
                class: student.class,
                code: scannedCode,
                time: now.toLocaleTimeString('ar-EG'),
                date: today,
                timestamp: now.getTime()
            };
            
            // Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙŠ localStorage
            attendanceRecords.push(attendanceRecord);
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            // Ø¹Ø±Ø¶ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØµØ­ Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡
            resultElement.innerHTML = `
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                    <p>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${student.name} Ø¨Ù†Ø¬Ø§Ø­</p>
                </div>
            `;
            
            // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚Ù„
            document.getElementById('studentId').value = '';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
            setTimeout(() => {
                resultElement.innerHTML = '';
            }, 5000);
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        window.onload = function() {
            const scannedCode = getScannedCode();
            
            if (!scannedCode) {
                document.getElementById('attendanceResult').innerHTML = '<span class="scan-error">ÙƒÙˆØ¯ QR ØºÙŠØ± ØµØ§Ù„Ø­</span>';
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ÙƒÙˆØ¯
            if (!isValidCode(scannedCode)) {
                document.getElementById('attendanceResult').innerHTML = '<span class="scan-error">ÙƒÙˆØ¯ QR Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</span>';
                return;
            }
            
            // Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
            document.addEventListener('keydown', function(e) {
                // Ù…Ù†Ø¹ F12 (Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†)
                if (e.key === 'F12') {
                    e.preventDefault();
                }
                // Ù…Ù†Ø¹ Ctrl+Shift+I / Ctrl+U / Ctrl+Shift+C
                if (e.ctrlKey && e.shiftKey && e.key === 'I') e.preventDefault();
                if (e.ctrlKey && e.shiftKey && e.key === 'C') e.preventDefault();
                if (e.ctrlKey && e.key === 'U') e.preventDefault();
            });
            
            // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¨Ø²Ø± Ø§Ù„Ù…Ø§ÙˆØ³ Ø§Ù„Ø£ÙŠÙ…Ù†
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });
        };
    </script>
</body>
</html>



