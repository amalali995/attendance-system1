<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الحضور - نظام الحضور</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-right"></i> العودة للرئيسية
            </a>
            <h1><i class="fas fa-clipboard-check"></i> تسجيل الحضور</h1>
            <div></div>
        </div>
        
        <div class="stats">
            <div class="stat-box total-stat">
                <i class="fas fa-users"></i>
                <h3 id="totalStudents">0</h3>
                <p>إجمالي الطلاب</p>
            </div>
            <div class="stat-box present-stat">
                <i class="fas fa-user-check"></i>
                <h3 id="presentStudents">0</h3>
                <p>الطلاب الحاضرين</p>
            </div>
            <div class="stat-box absent-stat">
                <i class="fas fa-user-times"></i>
                <h3 id="absentStudents">0</h3>
                <p>الطلاب الغائبين</p>
            </div>
        </div>
        
        <div class="attendance-section">
            <div class="scan-section">
                <h2 class="form-title">تسجيل الحضور</h2>
                <div class="form-group">
                    <label for="qrCodeInput">كود QR أو اسم الطالب:</label>
                    <input type="text" id="qrCodeInput" placeholder="أدخل كود QR أو اسم الطالب">
                </div>
                <button class="btn btn-success" onclick="manualAttendance()">
                    <i class="fas fa-check-circle"></i> تسجيل الحضور
                </button>
                
                <h2 class="form-title" style="margin-top: 30px;">إحصائيات اليوم</h2>
                <p id="attendanceDate"></p>
                <div class="controls">
                    <button class="btn btn-primary" onclick="exportToCSV()">
                        <i class="fas fa-file-export"></i> تصدير البيانات
                    </button>
                    <button class="btn btn-danger" onclick="clearAttendance()">
                        <i class="fas fa-trash"></i> مسح السجل
                    </button>
                </div>
            </div>
            
            <div class="students-list">
                <h2 class="form-title">قائمة الطلاب</h2>
                <table id="studentsTable">
                    <thead>
                        <tr>
                            <th>رقم الهوية</th>
                            <th>اسم الطالب</th>
                            <th>الصف</th>
                            <th>الحضور اليوم</th>
                            <th>وقت التسجيل</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // تحميل البيانات من localStorage
        let students = JSON.parse(localStorage.getItem('students')) || [];
        let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
        
        // تحديث الإحصائيات
        function updateStats() {
            const totalStudents = students.length;
            const today = new Date().toLocaleDateString('ar-EG');
            const presentCount = attendanceRecords.filter(record => 
                record.date === today).length;
            
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('presentStudents').textContent = presentCount;
            document.getElementById('absentStudents').textContent = totalStudents - presentCount;
            document.getElementById('attendanceDate').textContent =` تاريخ اليوم: ${today}`;
        }
        
        // تسجيل الحضور يدوياً
        function manualAttendance() {
            const qrInput = document.getElementById('qrCodeInput').value;
            
            if (!qrInput) {
                alert('يرجى إدخال اسم الطالب أو رقم الهوية');
                return;
            }
            
            // البحث عن الطالب
            const student = students.find(s => 
                s.name.includes(qrInput) || s.id === qrInput);
            
            if (!student) {
                alert('لم يتم العثور على الطالب. يرجى التأكد من البيانات');
                return;
            }
            
            // تسجيل الحضور
            const now = new Date();
            const timeString = now.toLocaleTimeString('ar-EG');
            const dateString = now.toLocaleDateString('ar-EG');
            
            // التحقق إذا كان الطالب سجل حضوره اليوم
            const todayRecords = attendanceRecords.filter(record => 
                record.date === dateString && record.studentId === student.id);
            
            if (todayRecords.length > 0) {
                alert(`الطالب ${student.name} سجل حضوره already today at ${todayRecords[0].time}`);
                document.getElementById('qrCodeInput').value = '';
                return;
            }
            
            attendanceRecords.push({
                studentId: student.id,
                studentName: student.name,
                time: timeString,
                date: dateString,
                qrCode: "تسجيل يدوي",
                status: 'حاضر'
            });
            
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            // تحديث الجدول والإحصائيات
            updateStudentsTable();
            updateStats();
            
            // تفريغ الحقول
            document.getElementById('qrCodeInput').value = '';
            
            alert(`تم تسجيل حضور الطالب: ${student.name}`);
        }
        
// تحديث جدول الطلاب
function updateStudentsTable() {
    const tableBody = document.querySelector('#studentsTable tbody');
    tableBody.innerHTML = '';
    
    const today = new Date().toLocaleDateString('ar-EG');
    const attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
    const students = JSON.parse(localStorage.getItem('students')) || [];
    
    students.forEach(student => {
        const row = document.createElement('tr');
        
        // البحث عن سجل الحضور للطالب لهذا اليوم
        const attendanceRecord = attendanceRecords.find(record => 
            record.studentId === student.id && record.date === today
        );
        
        row.innerHTML = `
            <td>${student.id}</td>
            <td>${student.name}</td>
            <td>${student.class}</td>
            <td class="${attendanceRecord ? 'status-present' : 'status-absent'}">
                ${attendanceRecord ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>'}
            </td>
            <td>${attendanceRecord ? attendanceRecord.time : 'لم يسجل'}</td>
        `;
        tableBody.appendChild(row);
    });
}
        
        // تصدير البيانات إلى CSV
        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "رقم الهوية,اسم الطالب,الصف,وقت التسجيل,التاريخ,كود QR,الحالة\n";
            
            const today = new Date().toLocaleDateString('ar-EG');
            const todayRecords = attendanceRecords.filter(record => record.date === today);
            
            todayRecords.forEach(record => {
                const student = students.find(s => s.id === record.studentId);
                const studentClass = student ? student.class : 'غير معروف';
                
                csvContent += `${record.studentId},${record.studentName},${studentClass},${record.time},${record.date},${record.qrCode},${record.status}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download",` سجل_الحضور_${new Date().toLocaleDateString('ar-EG')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // مسح سجل الحضور
        function clearAttendance() {
            if (confirm('هل أنت متأكد من رغبتك في مسح سجل الحضور بالكامل؟')) {
                attendanceRecords = [];
                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                updateStudentsTable();
                updateStats();
                alert('تم مسح سجل الحضور');
            }
        }
        
        // تهيئة الصفحة عند التحميل
        window.onload = function() {
            updateStudentsTable();
            updateStats();
        };
    </script>
</body>

</html>
